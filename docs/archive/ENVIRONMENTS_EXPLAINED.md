# GitHub Environments — Объяснение политики

**Дата:** 2025-11-12  
**Статус:** Актуально для Фазы 0

---

## Обзор

В новом репозитории используется политика **GitHub Environments** для staging и production деплоев. Это новая практика, которая не была в предыдущем репозитории.

---

## Что такое GitHub Environments?

GitHub Environments — это механизм GitHub Actions для управления деплоями в разные окружения с дополнительными возможностями защиты и контроля.

### Основные возможности:

1. **Deployment Protection Rules** — правила защиты деплоев
2. **Deployment Branches** — ограничение деплоев по веткам
3. **Environment Secrets** — секреты на уровне окружения
4. **Deployment History** — история всех деплоев
5. **Wait Timer** — задержка перед деплоем

---

## Зачем это нужно?

### В старом репозитории:

- Все секреты хранились на уровне репозитория
- Не было разделения по окружениям
- Нет дополнительной защиты production деплоев
- Нет истории деплоев по окружениям

### В новом репозитории:

- ✅ **Безопасность:** Можно настроить обязательные апрувы для production
- ✅ **Контроль:** Ограничение деплоев только из ветки `main`
- ✅ **Гибкость:** Возможность хранить секреты на уровне окружения
- ✅ **Отслеживание:** История всех деплоев в каждое окружение
- ✅ **Защита:** Wait timer для production (опционально)

---

## Как это работает?

### В workflows:

```yaml
jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://staging.go2asia.space
    
    steps:
      # ... шаги деплоя
```

Когда workflow использует `environment: staging`, GitHub:
1. Проверяет правила защиты для этого окружения
2. Ждёт апрува (если настроены reviewers)
3. Применяет wait timer (если настроен)
4. Записывает деплой в историю
5. Предоставляет доступ к секретам окружения

---

## Настройка Environments

### Staging Environment

**Назначение:** Промежуточное окружение для тестирования перед production.

**Рекомендуемые настройки:**
- **Deployment branches:** `main` (опционально)
- **Required reviewers:** Не обязательно (можно добавить для критичных изменений)
- **Wait timer:** Не нужен
- **Secrets:** Можно использовать секреты на уровне репозитория

**Использование:**
- Автоматический деплой при push в `main`
- Ручной деплой через `workflow_dispatch`

### Production Environment

**Назначение:** Продакшн окружение для пользователей.

**Рекомендуемые настройки:**
- **Deployment branches:** `main` (обязательно)
- **Required reviewers:** Рекомендуется (минимум 1 человек)
- **Wait timer:** Опционально (например, 5 минут)
- **Secrets:** Можно использовать секреты на уровне репозитория или окружения

**Использование:**
- Ручной деплой через `workflow_dispatch` с подтверждением
- Требует ввода "deploy" в workflow
- Валидация версии (семантическое версионирование)

---

## Секреты: Репозиторий vs Environment

### Секреты на уровне репозитория

**Плюсы:**
- Проще управлять (все в одном месте)
- Доступны всем окружениям
- Подходят для общих секретов (например, `CLOUDFLARE_API_TOKEN`)

**Минусы:**
- Нет разделения по окружениям
- Все окружения видят все секреты

**Пример:**
```
Repository Secrets:
  - CLOUDFLARE_API_TOKEN (общий для всех)
  - NETLIFY_AUTH_TOKEN (общий для всех)
```

### Секреты на уровне окружения

**Плюсы:**
- Разделение секретов по окружениям
- Более безопасно (staging не видит production секреты)
- Можно использовать разные токены для разных окружений

**Минусы:**
- Сложнее управлять (нужно добавлять в каждое окружение)
- Дублирование секретов

**Пример:**
```
Environment: staging
  - STAGING_DATABASE_URL
  - CLOUDFLARE_STAGING_API_TOKEN

Environment: production
  - PRODUCTION_DATABASE_URL
  - CLOUDFLARE_PRODUCTION_API_TOKEN
```

### Рекомендация для миграции

**Используйте секреты на уровне репозитория** (как в старом репо):
- Проще мигрировать
- Меньше дублирования
- Достаточно для большинства случаев

**Используйте секреты на уровне окружения**, если:
- Нужны разные токены для staging и production
- Требуется строгое разделение секретов
- Есть требования безопасности для разделения

---

## Deployment Protection Rules

### Required Reviewers

**Назначение:** Обязательные апрувы перед деплоем.

**Когда использовать:**
- Для production (рекомендуется)
- Для критичных изменений в staging

**Настройка:**
1. В Environment → Deployment protection rules
2. Включите "Required reviewers"
3. Добавьте людей или команды

**Как работает:**
- Workflow запускается
- Останавливается перед деплоем
- Ждёт апрува от указанных людей
- После апрува продолжает деплой

### Wait Timer

**Назначение:** Задержка перед деплоем (например, 5 минут).

**Когда использовать:**
- Для production (опционально)
- Даёт время отменить деплой если что-то не так

**Настройка:**
1. В Environment → Deployment protection rules
2. Включите "Wait timer"
3. Установите время (например, 5 минут)

### Deployment Branches

**Назначение:** Ограничение деплоев только из определённых веток.

**Рекомендуемые настройки:**
- **Staging:** `main` (опционально)
- **Production:** `main` (обязательно)

**Как работает:**
- Если деплой запускается не из `main`, GitHub блокирует его
- Защищает от случайных деплоев из feature веток

---

## Миграция со старого репозитория

### Что изменилось?

**Старый репозиторий:**
- Нет Environments
- Все секреты на уровне репозитория
- Нет защиты деплоев

**Новый репозиторий:**
- Есть Environments (`staging`, `production`)
- Секреты можно хранить на уровне репозитория (как в старом) или окружения
- Есть защита деплоев (опционально)

### Что нужно сделать?

1. **Создать Environments** (если их нет):
   - `staging`
   - `production`

2. **Настроить защиту** (опционально):
   - Required reviewers для production
   - Deployment branches для production

3. **Секреты:**
   - Можно оставить на уровне репозитория (как в старом репо)
   - Или перенести в Environments (если нужно разделение)

---

## Примеры использования

### Пример 1: Простая настройка (для миграции)

**Environments:**
- `staging` — без защиты
- `production` — без защиты (или с required reviewers)

**Секреты:**
- Все на уровне репозитория (как в старом репо)

**Результат:** Работает как старый репо, но с возможностью добавить защиту позже.

### Пример 2: Защищённая настройка

**Environments:**
- `staging` — без защиты
- `production` — с required reviewers и wait timer

**Секреты:**
- Общие секреты на уровне репозитория
- Специфичные секреты в Environments

**Результат:** Максимальная защита production деплоев.

---

## Troubleshooting

### Проблема: Workflow не запускается

**Причина:** Возможно, настроены deployment branches, и деплой запускается не из `main`.

**Решение:** Проверьте настройки Deployment branches в Environment.

### Проблема: Workflow ждёт апрува

**Причина:** Настроены Required reviewers.

**Решение:** Либо дождитесь апрува, либо отключите Required reviewers в настройках Environment.

### Проблема: Секреты не доступны

**Причина:** Секреты добавлены в Environment, но workflow не использует `environment:`.

**Решение:** Убедитесь что в workflow указан `environment: staging` или `environment: production`.

---

## Best Practices

1. **Начните с простого:** Используйте секреты на уровне репозитория для миграции
2. **Добавьте защиту постепенно:** Сначала настройте Environments, потом добавьте защиту
3. **Используйте Required reviewers для production:** Это защитит от случайных деплоев
4. **Ограничьте deployment branches:** Только `main` для production
5. **Документируйте изменения:** Записывайте все изменения в Environments

---

## Ссылки

- [GitHub Environments Documentation](https://docs.github.com/en/actions/deployment/targeting-different-environments/using-environments-for-deployment)
- [Deployment Protection Rules](https://docs.github.com/en/actions/deployment/targeting-different-environments/using-environments-for-deployment#deployment-protection-rules)
- [Environment Secrets](https://docs.github.com/en/actions/deployment/targeting-different-environments/using-environments-for-deployment#environment-secrets)

---

**Последнее обновление:** 2025-11-12

